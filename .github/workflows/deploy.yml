# ============================================
# QuantTrade AI - Push-to-Deploy CI/CD Pipeline
# ============================================
# 
# Triggers on push to main branch
# Builds Docker images in GitHub Actions
# Pushes to GitHub Container Registry (GHCR)
# Deploys to EC2 via SSH
#
# Required GitHub Secrets:
#   - EC2_HOST: EC2 public IP or hostname
#   - EC2_USER: SSH username (ubuntu)
#   - EC2_SSH_KEY: Private SSH key for EC2
#   - GHCR_TOKEN: GitHub token for container registry (or use GITHUB_TOKEN)
# ============================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/quanttrade-frontend
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/quanttrade-backend

jobs:
  # ==========================================
  # Build and Push Docker Images
  # ==========================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          platforms: linux/amd64

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          platforms: linux/amd64
          build-args: |
            NEXT_PUBLIC_API_URL=https://www.quanttrade.us

  # ==========================================
  # Deploy to EC2
  # ==========================================
  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy deployment files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.prod.yml,nginx/"
          target: "/opt/quanttrade"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            # Navigate to deployment directory
            cd /opt/quanttrade
            
            # ===== STOP SYSTEM SERVICES THAT MAY USE PORT 80/443 =====
            echo "üõë Stopping any system nginx/apache..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl disable nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true
            sudo systemctl disable apache2 2>/dev/null || true
            
            # ===== CLEANUP DISK SPACE =====
            echo "üßπ Cleaning up disk space..."
            docker system prune -af --volumes || true
            sudo rm -rf /var/lib/containerd/io.containerd.content.v1.content/ingest/* || true
            echo "Disk space available:"
            df -h /
            
            # ===== STOP EXISTING DOCKER STACK =====
            echo "üîª Stopping existing containers..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            
            # ===== KILL ANY CONTAINER USING PORT 80/443 =====
            echo "üîç Checking for containers using port 80/443..."
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -q --filter "publish=443" | xargs -r docker stop || true
            
            # ===== VERIFY PORTS ARE FREE =====
            echo "‚úÖ Verifying ports 80/443 are free..."
            if sudo ss -lntp | grep -E ':80\s|:443\s' | grep -v docker; then
              echo "‚ùå ERROR: Port 80 or 443 still in use by non-Docker process!"
              sudo ss -lntp | grep -E ':80\s|:443\s'
              exit 1
            fi
            echo "Ports 80/443 are free."
            
            # ===== LOGIN TO GHCR =====
            echo "üîê Logging into GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ===== PULL LATEST IMAGES =====
            echo "üì• Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull
            
            # ===== START CONTAINERS =====
            echo "üöÄ Starting containers..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # ===== WAIT AND HEALTH CHECK =====
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            # Health check with retries
            for i in 1 2 3 4 5; do
              if curl -sf http://localhost/health; then
                echo "‚úÖ Health check passed!"
                break
              else
                echo "Waiting for nginx... (attempt $i/5)"
                sleep 5
              fi
            done
            
            # Final verification
            if ! curl -sf http://localhost/health; then
              echo "‚ùå Health check failed! Showing logs..."
              docker compose -f docker-compose.prod.yml ps
              docker logs --tail=50 quanttrade-nginx
              docker logs --tail=50 quanttrade-backend
              exit 1
            fi
            
            # ===== POST-DEPLOY CLEANUP =====
            echo "üßπ Post-deploy cleanup..."
            docker image prune -af || true
            docker builder prune -af || true
            
            # Show running containers
            echo "üìä Running containers:"
            docker ps
            
            echo "‚úÖ Deployment complete!"

  # ==========================================
  # Post-Deploy Health Check
  # ==========================================
  health-check:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Check Backend Health
        run: |
          curl -f https://quanttrade.us/api/v1/health || \
          curl -f http://${{ secrets.EC2_HOST }}:8000/health || \
          echo "::warning::Backend health check inconclusive"

      - name: Check Frontend Health
        run: |
          curl -f https://quanttrade.us/ || \
          curl -f http://${{ secrets.EC2_HOST }}:3000/ || \
          echo "::warning::Frontend health check inconclusive"
